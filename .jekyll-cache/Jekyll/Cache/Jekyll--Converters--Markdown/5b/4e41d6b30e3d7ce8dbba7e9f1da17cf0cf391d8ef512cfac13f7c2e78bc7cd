I"’<p>A3C Paper Link: <a href="https://arxiv.org/abs/1602.01783">https://arxiv.org/abs/1602.01783</a></p>

<h1 id="actor-critic-ì´ë€">Actor-Critic ì´ë€?</h1>

<p>REINFORCE with Baselineì˜ update ruleì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<p><img src="https://user-images.githubusercontent.com/45442859/128862419-41a25faa-8079-4d46-8621-35465e3a4303.png" alt="image" /></p>

<p>REINFORCEì˜ ê·¼ë³¸ì ì¸ ëª©í‘œëŠ” í–‰ë™ê°€ì¹˜í•¨ìˆ˜ë¥¼ í†µí•´ í˜„ì¬ì˜ policyë¥¼ í•™ìŠµí•˜ëŠ” ê²ƒì¸ë°, ì´ëŠ” ì–´ë–¤ í–‰ë™ì„ ì·¨í•˜ê³  ê·¸ actionì˜ í–‰ë™ê°€ì¹˜í•¨ìˆ˜ ê°’ì´ ë†’ìœ¼ë©´
ê·¸ actionì„ í•  í™•ë¥ ì„ ë†’ì´ë„ë¡ policyì˜ parameterë¥¼ ì¡°ì •í•˜ëŠ” ì‹ìœ¼ë¡œ ì´ë£¨ì–´ì§„ë‹¤. í•˜ì§€ë§Œ Baselineìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ìƒíƒœê°€ì¹˜í•¨ìˆ˜ëŠ” ìœ„ ê°™ì€ í–‰ë™ì„ ì·¨í•˜ê¸° ì „ì„ ê¸°ì¤€ìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸ì—
í•´ë‹¹ actionì´ ì¢‹ì€ì§€ ë‚˜ìœì§€ë¥¼ íŒë‹¨í•˜ê¸°ì—” ì ì ˆí•˜ì§€ ì•Šë‹¤.</p>

<p>ë˜í•œ, REINFORCEëŠ” Monte Carlo ê³ ìœ ì˜ ë¬¸ì œì¸ high varianceì™€ episodeê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼ í•œë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. returnì„ í•™ìŠµí•œ Q-networkë¡œë¶€í„° ì–»ì–´ì„œ stepë§ˆë‹¤ ì—…ë°ì´íŠ¸ í•˜ëŠ” ê²ƒì„ ì œì•ˆí•œ ê²ƒì´
Actor-Critic Methodì´ë‹¤.</p>

<p>ì—í”¼ì†Œë“œê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ actual returnì„ ì‚¬ìš©í•˜ëŠ” ê²Œ ì•„ë‹Œ TD(0)ì™€ ê°™ì€ ì¶”ì •ê°’ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ë‹¤.</p>

<p><img src="https://user-images.githubusercontent.com/45442859/128868704-ad371a00-4c05-451f-9cf1-9272b5031389.png" alt="image" /></p>

<p>ì—¬ê¸°ì„œ R<sub>t+1</sub>ì€ í™˜ê²½ìœ¼ë¡œë¶€í„° ì–»ì€ ì‹¤ì œê°’ì´ë¯€ë¡œ ì·¨í•œ actionì— ëŒ€í•œ í‰ê°€ê°€ ê°€ëŠ¥í•´ì§„ë‹¤.
ì•ì—ì„œ ë§í–ˆë“¯ì´, ìœ„ì™€ ê°™ S<sub>t+1</sub>ì—ì„œì˜ ì¶”ì •ê°’ì„ ì‚¬ìš©í•˜ë©´ biasê°€ ìƒê¸°ê¸´ í•˜ì§€ë§Œ variance ì¸¡ë©´ì—ì„œ ì¥ì ì´ ìˆê³ , online updateê°€ ê°€ëŠ¥í•˜ëŠ” ì¥ì ì´ ìˆë‹¤.
bias ê°™ì€ ê²½ìš°ëŠ” TD(1), TD(2), â€¦ì™€ ê°™ì´ n-step returnì„ ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ì¤„ì¼ ìˆ˜ ìˆë‹¤. 
ì´ë ‡ê²Œ actionì˜ qualityë¥¼ í‰ê°€í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ìƒíƒœê°€ì¹˜í•¨ìˆ˜ë¥¼ criticì´ë¼ê³  í•œë‹¤.</p>

<h2 id="pseudocode-for-reinforce">Pseudocode for REINFORCE</h2>

<p>Actor-criticê³¼ REINFORCEì˜ ë¹„êµë¥¼ ìœ„í•´ REINFORCEì˜ Pseudo ì½”ë“œë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ë³´ê³  ê°€ì.</p>

<p><img src="https://user-images.githubusercontent.com/45442859/128873153-4859a50c-94e3-4d59-9d07-c7a0df078159.png" alt="image" /></p>

<h2 id="pseudocode-for-td-actor-critic">Pseudocode for TD actor critic</h2>

<p><img src="https://user-images.githubusercontent.com/45442859/128870090-a57ee7ad-9a46-41b2-94a0-92b7cee43380.png" alt="image" /></p>

<p>actionì„ samplingí•˜ëŠ” í˜„ì¬ì˜ policyë¥¼ actorë¼ ì¹­í•˜ê³ , ì´ë¥¼ í‰ê°€í•˜ëŠ” ìƒíƒœê°€ì¹˜í•¨ìˆ˜ë¥¼ criticì´ë¼ ì¹­í•œë‹¤. 
ë‘˜ë‹¤ í•™ìŠµì„ ì‹œì¼œì¤˜ì•¼ëœë‹¤. TD Actor-criticì€ criticìœ¼ë¡œ TD errorë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì´ë‹¤.
Actorì˜ ê²½ìš° ê²½ì‚¬ í•˜ê°•ì„ í†µí•´ loss functionì„ ìµœì†Œí™” í•´ì¤˜ì•¼ í•˜ê³ , Critic ê°™ì€ ê²½ìš°ëŠ” ì•ì—ì„œ ë³¸ ê²ƒê³¼ ê°™ì´ ìµœëŒ€í™” ì‹œì¼œì¤˜ì•¼ í•˜ê¸° ë•Œë¬¸ì— ê²½ì‚¬ ìƒìŠ¹ì„ ì´ìš©í•œë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>

<span class="kn">from</span> <span class="nn">torch.distributions.categorical</span> <span class="kn">import</span> <span class="n">Categorical</span>

<span class="k">class</span> <span class="nc">A2C</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy_net</span><span class="p">,</span> <span class="n">value_net</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lr</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">A2C</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">policy_net</span> <span class="o">=</span> <span class="n">policy_net</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">value_net</span> <span class="o">=</span> <span class="n">value_net</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">policy_net</span><span class="p">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">value_net</span><span class="p">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">_eps</span> <span class="o">=</span> <span class="mf">1e-25</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_mse</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">policy_net</span><span class="p">(</span><span class="n">state</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">dist</span><span class="p">.</span><span class="n">sample</span><span class="p">()</span> <span class="c1"># torch.Size([1])
</span>        <span class="k">return</span> <span class="n">a</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>

        <span class="c1"># action size: torch.Size([1,1])
</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">next_state</span><span class="p">).</span><span class="nb">float</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="n">next_state</span><span class="p">.</span><span class="n">view</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="c1"># value_net inputì€ size [1,4]ì—¬ì•¼ í•¨.
</span>        <span class="n">reward</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reward</span><span class="p">).</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">td_target</span> <span class="o">=</span> <span class="n">reward</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">value_net</span><span class="p">(</span><span class="n">next_state</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span>
            <span class="n">td_error</span> <span class="o">=</span> <span class="n">td_target</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">value_net</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">policy_net</span><span class="p">(</span><span class="n">state</span><span class="p">))</span> <span class="c1"># torch.Size([1,2])
</span>        <span class="n">prob</span> <span class="o">=</span> <span class="n">dist</span><span class="p">.</span><span class="n">probs</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">action</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">value_net</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">_eps</span><span class="p">)</span><span class="o">*</span><span class="n">td_error</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">_mse</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">td_target</span><span class="o">*</span><span class="n">td_error</span>  <span class="c1"># policy loss + value loss / shape: torch.Size([1,1])
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span><span class="p">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># shape: torch.Size([])
</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

</code></pre></div></div>

<p>TD Errorì˜ ê²½ìš° Advantage Functionì˜ unbiased estimateì´ë¯€ë¡œ Criticìœ¼ë¡œ Advantage Functionì„ ì‚¬ìš©í•˜ê¸°ë„ í•œë‹¤.
í•˜ì§€ë§Œ TD Errorì„ ì‚¬ìš©í•˜ë©´ Advantage Functionì„ ì‚¬ìš©í•  ë•Œì™€ ë‹¬ë¦¬, ìƒíƒœê°€ì¹˜í•¨ìˆ˜ë§Œ í•™ìŠµí•˜ë©´ ëœë‹¤.</p>

<h2 id="pseudocode-for-q-actor-critic">Pseudocode for Q actor critic</h2>

<p>Criticìœ¼ë¡œ í•™ìŠµí•œ Q function ì‚¬ìš©</p>

<p><img src="https://user-images.githubusercontent.com/45442859/128870844-0e8ce83f-1a74-4ddf-9a2d-964d5c8eea80.png" alt="image" /></p>

<h2 id="actor-critic-ì¢…ë¥˜">Actor-Critic ì¢…ë¥˜</h2>

<p><img src="https://user-images.githubusercontent.com/45442859/129993657-1aa7d106-6773-461a-ae99-e4a99db60894.png" alt="image" /></p>

<h1 id="asynchronous-advantage-actor-critic">Asynchronous Advantage Actor-Critic</h1>

<p>ë…¼ë¬¸ì—ì„œ ë‹¤ë£¨ëŠ” A3C ì•Œê³ ë¦¬ì¦˜ì€ TD Actor-Criticì„ Asynchronousí•˜ê²Œ ì—…ë°ì´íŠ¸í•œë‹¤. ì¦‰, Globalí•˜ê²Œ ê³µìœ í•˜ëŠ” Actor-Critic pairë¥¼ ì—¬ëŸ¬ê°œì˜ Actor-Critic threadë¥¼ í†µí•´
ì—…ë°ì´íŠ¸í•˜ëŠ” ê³¼ì •ì´ë‹¤. Trainingê³¼ ì •ì€ TD Actor-Criticê³¼ ë™ì¼í•˜ë©°, ì—¬ëŸ¬ ê°œì˜ threadë¥¼ ì‚¬ìš©í•´ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•œë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤.</p>

<h2 id="pseudocode-for-a3c">Pseudocode for A3C</h2>

<p><img src="https://user-images.githubusercontent.com/45442859/130006230-ef9e6924-2ee9-4439-8e6f-77c656d75c83.png" alt="image" /></p>

<ul>
  <li>tëŠ” local actor-critic thread ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì‚¬ìš©ë¨.</li>
  <li>TëŠ” local actor-critic updateì˜ ì´í•©. ì¦‰, global actor-criticì´ ëª‡ ë²ˆ ì—…ë°ì´íŠ¸ ë˜ì—ˆëŠ”ì§€ë¥¼ ì²´í¬.</li>
  <li>local actor-criticì€ global actor-criticìœ¼ë¡œë¶€í„° parameterë¥¼ t<sub>max</sub>ë§ˆë‹¤ ë³µì‚¬í•´ì„œ í•™ìŠµì— ì‚¬ìš©.</li>
  <li>Loss functionì„ ë³´ë©´ TD errorê°€ ì‚¬ìš©ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.</li>
</ul>

<h2 id="implementation-of-a3c">Implementation of A3C</h2>

<p>Miltiprocessingì„ ì§„í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— êµ¬í˜„ì„ ì–´ë–»ê²Œ í•´ì•¼í• ì§€ ê°ì´ ì•ˆ ì™”ë‹¤. ê·¸ë˜ì„œ ê·¸ëƒ¥ ëŠë‚Œë§Œ ì¡ê³  ê°€ê¸°ë¡œ ê²°ì •!</p>

<p><a href="https://github.com/seungeunrho/minimalRL">https://github.com/seungeunrho/minimalRL</a></p>

<p>ê°•í™”í•™ìŠµ ìœ íŠœë²„ íŒ¡ìš”ë© ë‹˜ì´ ìš´ì˜í•˜ì‹œëŠ” Githubì¸ë° ë…¼ë¬¸ ì½ê¸° ì „ì— ê´€ë ¨ ì˜ìƒì„ ë³´ê³  ì½ìœ¼ë©´ ì´í•´ê°€ ë” ì˜ ëœë‹¤. ì¶”ì²œ!</p>

<p>ê·¸ë¦¬ê³  ìœ„ A3C ì½”ë“œê°€ ë‚´ê°€ êµ¬ê¸€ë§í•´ì„œ ë³¸ ëª¨ë“  ì½”ë“œ ì¤‘ì—ì„œ ê°€ì¥ ê°„ê²°í•˜ê³  ë…¼ë¬¸ flow ê·¸ëŒ€ë¡œ êµ¬í˜„í•œ ê²ƒ ê°™ë‹¤.</p>

<p>ìœ„ì˜ Vanilla Actor-Criticê³¼ ë¹„êµí–ˆì„ ë•Œ ì§„ì§œ ë¹ ë¥´ê³ , ì„±ëŠ¥ì´ ì¢‹ë‹¤â€¦ ì‹ ê¸°â€¦</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Categorical</span>
<span class="kn">import</span> <span class="nn">torch.multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Hyperparameters
</span><span class="n">n_train_processes</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.0002</span>
<span class="n">update_interval</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.98</span>
<span class="n">max_train_ep</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">max_test_ep</span> <span class="o">=</span> <span class="mi">520</span>


<span class="k">class</span> <span class="nc">ActorCritic</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActorCritic</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc_pi</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc_v</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">softmax_dim</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc_pi</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">softmax_dim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">prob</span>

    <span class="k">def</span> <span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc_v</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>


<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">global_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
    <span class="n">local_model</span> <span class="o">=</span> <span class="n">ActorCritic</span><span class="p">()</span>
    <span class="n">local_model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">global_model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">global_model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="s">'CartPole-v1'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n_epi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_train_ep</span><span class="p">):</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span> <span class="c1"># s.shape -&gt; (4,)
</span>        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="n">s_lst</span><span class="p">,</span> <span class="n">a_lst</span><span class="p">,</span> <span class="n">r_lst</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">update_interval</span><span class="p">):</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">local_model</span><span class="p">.</span><span class="n">pi</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nb">float</span><span class="p">())</span> <span class="c1"># torch.size([2]) | torch.from_numpy(s).shape: torch.size([4])
</span>                <span class="n">m</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">sample</span><span class="p">().</span><span class="n">item</span><span class="p">()</span> <span class="c1"># int
</span>                <span class="n">s_prime</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

                <span class="n">s_lst</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">a_lst</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="p">])</span>
                <span class="n">r_lst</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mf">100.0</span><span class="p">)</span>

                <span class="n">s</span> <span class="o">=</span> <span class="n">s_prime</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">s_final</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">s_prime</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># torch.size([4])
</span>            <span class="n">R</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">done</span> <span class="k">else</span> <span class="n">local_model</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="n">s_final</span><span class="p">).</span><span class="n">item</span><span class="p">()</span>
            <span class="n">td_target_lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reward</span> <span class="ow">in</span> <span class="n">r_lst</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">R</span> <span class="o">+</span> <span class="n">reward</span> <span class="c1"># n-step TD target
</span>                <span class="n">td_target_lst</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">R</span><span class="p">])</span>
            <span class="n">td_target_lst</span><span class="p">.</span><span class="n">reverse</span><span class="p">()</span>

            <span class="n">s_batch</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">,</span> <span class="n">td_target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">s_lst</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">a_lst</span><span class="p">),</span> \
                <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">td_target_lst</span><span class="p">)</span> <span class="c1"># torch.size([update_interval,4]), torch.size([update_interval,1]), torch.size([update_interval,1])
</span>            <span class="n">advantage</span> <span class="o">=</span> <span class="n">td_target</span> <span class="o">-</span> <span class="n">local_model</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="n">s_batch</span><span class="p">)</span>

            <span class="n">pi</span> <span class="o">=</span> <span class="n">local_model</span><span class="p">.</span><span class="n">pi</span><span class="p">(</span><span class="n">s_batch</span><span class="p">,</span> <span class="n">softmax_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pi_a</span> <span class="o">=</span> <span class="n">pi</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">a_batch</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">pi_a</span><span class="p">)</span> <span class="o">*</span> <span class="n">advantage</span><span class="p">.</span><span class="n">detach</span><span class="p">()</span> <span class="o">+</span> \
                <span class="n">F</span><span class="p">.</span><span class="n">smooth_l1_loss</span><span class="p">(</span><span class="n">local_model</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="n">s_batch</span><span class="p">),</span> <span class="n">td_target</span><span class="p">.</span><span class="n">detach</span><span class="p">())</span> <span class="c1"># torch.size([5,1])
</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">.</span><span class="n">mean</span><span class="p">().</span><span class="n">backward</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">global_param</span><span class="p">,</span> <span class="n">local_param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">global_model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">local_model</span><span class="p">.</span><span class="n">parameters</span><span class="p">()):</span>
                <span class="n">global_param</span><span class="p">.</span><span class="n">_grad</span> <span class="o">=</span> <span class="n">local_param</span><span class="p">.</span><span class="n">grad</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">local_model</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">global_model</span><span class="p">.</span><span class="n">state_dict</span><span class="p">())</span> 

    <span class="n">env</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Training process {} reached maximum episode."</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">rank</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">global_model</span><span class="p">):</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="p">.</span><span class="n">make</span><span class="p">(</span><span class="s">'CartPole-v1'</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">print_interval</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="k">for</span> <span class="n">n_epi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_test_ep</span><span class="p">):</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_epi</span> <span class="o">&gt;</span> <span class="mi">390</span><span class="p">:</span>
                <span class="n">env</span><span class="p">.</span><span class="n">render</span><span class="p">()</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">global_model</span><span class="p">.</span><span class="n">pi</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nb">float</span><span class="p">())</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Categorical</span><span class="p">(</span><span class="n">prob</span><span class="p">).</span><span class="n">sample</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>
            <span class="n">s_prime</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s_prime</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">r</span>

        <span class="k">if</span> <span class="n">n_epi</span> <span class="o">%</span> <span class="n">print_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_epi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"# of episode :{}, avg score : {:.1f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">n_epi</span><span class="p">,</span> <span class="n">score</span><span class="o">/</span><span class="n">print_interval</span><span class="p">))</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">env</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">global_model</span> <span class="o">=</span> <span class="n">ActorCritic</span><span class="p">()</span>
    <span class="n">global_model</span><span class="p">.</span><span class="n">share_memory</span><span class="p">()</span>

    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Available CPU Count:"</span><span class="p">,</span> <span class="n">n_train_processes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rank</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_train_processes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># + 1 for test process
</span>        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">global_model</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">train</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">global_model</span><span class="p">,</span> <span class="n">rank</span><span class="p">,))</span>
        <span class="n">p</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">processes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
        <span class="n">p</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>

</code></pre></div></div>

<ul>
  <li>mp.cpu_count()ë¥¼ í•˜ë©´ ëŒë¦´ ìˆ˜ ìˆëŠ” cpu ê°œìˆ˜ê°€ ë‚˜ì˜¤ëŠ”ë° ë‚´ê»€ 12ê°œì˜€ë‹¤.</li>
  <li>ê°ê° actor-critic threadê°€ max_train_epë§Œí¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³ , update_intervalë§ˆë‹¤ global actor-criticì„ ì—…ë°ì´íŠ¸í•˜ë¯€ë¡œ 
ê° local threadì—ì„œ max_train_ep/update_interval (ì—¬ê¸°ì„  500/5 = 100)ë§Œí¼ global actor-criticì„ ì—…ë°ì´íŠ¸ í•œë‹¤.</li>
  <li>Local threadê°€ 12ê°œì´ë¯€ë¡œ ì´ 1200ë²ˆì˜ ì—…ë°ì´íŠ¸ê°€ ì´ë£¨ì–´ì§€ëŠ”ë°, ê·¸ëƒ¥ vanilla actor-criticì„ ì¼ì„ ë•Œë³´ë‹¤ 10ë°° ì •ë„ ì—í”¼ì†Œë“œ íš¨ìœ¨ì´ ì¢‹ì€ ê²ƒ ê°™ë‹¤.</li>
</ul>
:ET